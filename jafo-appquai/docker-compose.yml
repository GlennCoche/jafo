# AppQUAI — Node QUAI (go-quai) + Stratum + Dashboard
# Umbrel : app_proxy sans image (injecté par Umbrel), pas de section networks (géré par Umbrel).
# Init intégré dans l'entrypoint go-quai (pas de conteneur init qui s'arrête = meilleure compatibilité Umbrel).
# Images multi-arch (arm64 + amd64) : ./build-and-push.sh 1.0.0

services:
  app_proxy:
    environment:
      APP_HOST: jafo-appquai_server_1
      APP_PORT: "3000"

  go-quai:
    image: glenncoche/appquai-go-quai:1.0.1
    user: "0:0"
    init: true
    restart: unless-stopped
    stop_grace_period: 60s
    environment:
      DATA_DIR: /data
      CONFIG_DIR: /config
    volumes:
      - ${APP_DATA_DIR:-./data}/quai-data:/data
      - ${APP_DATA_DIR:-./data}/config:/config:ro
    ports:
      - "3333:3333"

  server:
    image: glenncoche/appquai-server:1.0.1
    init: true
    restart: on-failure
    stop_grace_period: 30s
    depends_on:
      - go-quai
    environment:
      GO_QUAI_API_URL: http://go-quai:3336
      MINER_IP: ${MINER_IP:-}
      CONFIG_DIR: /app/data/config
    volumes:
      - ${APP_DATA_DIR:-./data}:/app/data
