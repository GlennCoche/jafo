# AppQUAI — Node QUAI (go-quai) + Stratum + Dashboard
# Umbrel : app_proxy sans image (injecté par Umbrel), pas de section networks (géré par Umbrel).
# Images multi-arch (arm64 + amd64) requises : ./build-and-push.sh 1.0.0

services:
  app_proxy:
    environment:
      APP_HOST: jafo-appquai_server_1
      APP_PORT: "3000"

  init:
    image: glenncoche/appquai-init:1.0.0
    environment:
      APP_DATA_DIR: /appdata
    volumes:
      - ${APP_DATA_DIR:-./data}:/appdata

  go-quai:
    image: glenncoche/appquai-go-quai:1.0.0
    user: "0:0"
    init: true
    restart: unless-stopped
    stop_grace_period: 60s
    depends_on:
      init:
        condition: service_completed_successfully
    environment:
      DATA_DIR: /data
      CONFIG_DIR: /config
    volumes:
      - ${APP_DATA_DIR:-./data}/quai-data:/data
      - ${APP_DATA_DIR:-./data}/config:/config:ro
    ports:
      - "3333:3333"
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O- http://127.0.0.1:3336/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  server:
    image: glenncoche/appquai-server:1.0.0
    init: true
    restart: on-failure
    stop_grace_period: 30s
    depends_on:
      init:
        condition: service_completed_successfully
    environment:
      GO_QUAI_API_URL: http://go-quai:3336
      MINER_IP: ${MINER_IP:-}
      CONFIG_DIR: /app/data/config
    volumes:
      - ${APP_DATA_DIR:-./data}:/app/data
