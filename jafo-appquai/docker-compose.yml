# AppQUAI â€” Node QUAI (go-quai) + Stratum + Dashboard
# Umbrel: app_proxy, init, go-quai, server (dashboard)

services:
  # Umbrel replaces this service with its proxy at runtime; image + command for local docker compose
  app_proxy:
    image: alpine:latest
    command: ["tail", "-f", "/dev/null"]
    environment:
      APP_HOST: jafo-appquai_server_1
      APP_PORT: "3000"
    networks:
      - umbrel_main_network

  init:
    image: glenncoche/appquai-init:1.0.0
    environment:
      APP_DATA_DIR: /appdata
    volumes:
      - ${APP_DATA_DIR:-./data}:/appdata
    networks:
      - umbrel_main_network

  go-quai:
    image: glenncoche/appquai-go-quai:1.0.0
    user: "0:0"
    init: true
    restart: unless-stopped
    stop_grace_period: 60s
    depends_on:
      init:
        condition: service_completed_successfully
    environment:
      DATA_DIR: /data
      CONFIG_DIR: /config
    volumes:
      - ${APP_DATA_DIR:-./data}/quai-data:/data
      - ${APP_DATA_DIR:-./data}/config:/config:ro
    ports:
      - "3333:3333"
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O- http://127.0.0.1:3336/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - umbrel_main_network

  server:
    image: glenncoche/appquai-server:1.0.0
    init: true
    restart: on-failure
    stop_grace_period: 30s
    depends_on:
      init:
        condition: service_completed_successfully
    environment:
      GO_QUAI_API_URL: http://go-quai:3336
      MINER_IP: ${MINER_IP:-}
      CONFIG_DIR: /app/data/config
    volumes:
      - ${APP_DATA_DIR:-./data}:/app/data
    networks:
      - umbrel_main_network

networks:
  umbrel_main_network:
    external: true
